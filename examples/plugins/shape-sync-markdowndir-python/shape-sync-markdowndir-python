#!/usr/bin/env python3

import json
import os
import re
import sys
from datetime import datetime, timezone

OUTPUT_DIR = os.environ.get("SHAPE_SYNC_MARKDOWN_DIR", "./pitches")

MANIFEST = {
    "name": "shape-sync-markdowndir-python",
    "version": "1.0.0",
    "description": "Sync briefs to markdown directory (Python)",
    "type": "sync",
    "operations": ["push", "pull", "status", "test"],
}


def slugify(title):
    slug = title.lower()
    slug = re.sub(r"[^a-z0-9]+", "-", slug)
    slug = slug.strip("-")
    return slug


def generate_markdown(brief):
    lines = ["---"]
    lines.append(f"id: {brief['id']}")
    lines.append(f"title: \"{brief['title']}\"")
    lines.append(f"status: {brief.get('status', 'proposed')}")
    if brief.get("appetite"):
        lines.append(f"appetite: {brief['appetite']}")
    synced_at = datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")
    lines.append(f"synced_at: {synced_at}")
    lines.append("---")
    lines.append("")
    lines.append(brief.get("body", ""))
    return "\n".join(lines)


def parse_frontmatter(content):
    match = re.match(r"^---\n(.+?)\n---\n\n?(.*)", content, re.DOTALL)
    if not match:
        return None

    frontmatter_text = match.group(1)
    body = match.group(2)

    brief = {"body": body}

    for line in frontmatter_text.split("\n"):
        if line.startswith("id:"):
            brief["id"] = line[3:].strip()
        elif line.startswith("title:"):
            title = line[6:].strip()
            title = title.strip('"')
            brief["title"] = title
        elif line.startswith("status:"):
            brief["status"] = line[7:].strip()
        elif line.startswith("appetite:"):
            brief["appetite"] = line[9:].strip()

    return brief


def handle_test():
    return {"success": True}


def handle_push(params):
    briefs = params.get("briefs", [])

    os.makedirs(OUTPUT_DIR, exist_ok=True)

    mappings = []
    for brief in briefs:
        filename = f"{brief['id']}-{slugify(brief['title'])}.md"
        filepath = os.path.join(OUTPUT_DIR, filename)

        with open(filepath, "w", encoding="utf-8") as f:
            f.write(generate_markdown(brief))

        mappings.append({
            "local_id": brief["id"],
            "remote_id": filename,
            "entity_type": "brief",
        })

    return {
        "success": True,
        "data": {
            "pushed": len(briefs),
            "pulled": 0,
            "conflicts": 0,
            "errors": [],
            "mappings": mappings,
        },
    }


def handle_pull():
    if not os.path.isdir(OUTPUT_DIR):
        return {
            "success": True,
            "data": {
                "briefs": [],
                "tasks": [],
                "mappings": [],
                "pushed": 0,
                "pulled": 0,
                "conflicts": 0,
                "errors": [],
            },
        }

    briefs = []
    for filename in os.listdir(OUTPUT_DIR):
        if not filename.endswith(".md"):
            continue

        filepath = os.path.join(OUTPUT_DIR, filename)
        with open(filepath, encoding="utf-8") as f:
            content = f.read()

        brief = parse_frontmatter(content)
        if brief:
            briefs.append(brief)

    return {
        "success": True,
        "data": {
            "briefs": briefs,
            "tasks": [],
            "mappings": [],
            "pushed": 0,
            "pulled": len(briefs),
            "conflicts": 0,
            "errors": [],
        },
    }


def handle_status():
    count = 0
    if os.path.isdir(OUTPUT_DIR):
        count = len([f for f in os.listdir(OUTPUT_DIR) if f.endswith(".md")])

    return {
        "success": True,
        "data": {
            "mapped_briefs": count,
            "mapped_tasks": 0,
        },
    }


def handle_request(request):
    operation = request.get("operation")
    params = request.get("params", {})

    if operation == "test":
        return handle_test()
    elif operation == "push":
        return handle_push(params)
    elif operation == "pull":
        return handle_pull()
    elif operation == "status":
        return handle_status()
    else:
        return {"success": False, "error": f"Unknown operation: {operation}"}


if __name__ == "__main__":
    if "--manifest" in sys.argv:
        print(json.dumps(MANIFEST))
    else:
        request = json.loads(sys.stdin.readline())
        response = handle_request(request)
        print(json.dumps(response))
